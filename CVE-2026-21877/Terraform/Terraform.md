
## üöÄ Step-by-Step: GCP Lab Deployment (CVE-2026-21877)

This guide walks you through provisioning the lab infrastructure on Google Cloud Platform using Terraform, configuring n8n for persistence, and executing the exploit.

### üìã 1. Prerequisites

Before you begin, ensure you have the following:

* GCP Project: An active Google Cloud project ID.

* Terraform: Installed on your local machine.

* SSH Key: An existing SSH key pair at ~/.ssh/id_rsa.pub (used for VM access).

* Local IP: Your current public IPv4 address (needed for firewall whitelisting).

### üõ†Ô∏è 2. Infrastructure Setup

**A. Initialize Terraform**

Navigate to the directory containing your ```main.tf``` and initialize the providers:
```bash
terraform init
```

**B. Deploy the VM**

Run the following command. This automatically fetches your public IP to whitelist your machine in the GCP firewall:
```bash
terraform apply \
  -var="project_id=YOUR_PROJECT_ID_HERE" \
  -var="my_ip=$(curl -s ifconfig.me)/32"
```

* **Project ID**: Replace ```YOUR_PROJECT_ID_HERE``` with your actual GCP project ID.
* **Confirmation**: Type ```yes``` when prompted.

### ‚öôÔ∏è 3. Lab Initialization

Wait **3 to 5 minutes** after the Terraform command finishes. During this time, the VM's startup script is:

* Installing Docker and Docker Compose.
* Cloning your GitHub repository.
* Injecting the VM's static IP into the ```docker-compose.yml```.
* Starting the containers.

**Verify n8n Access**

Open your browser and navigate to: ```http://<LAB_PUBLIC_IP>:5678```

### üîì 4. Setting up Persistence (Important)

By default, n8n only listens for one "Test" event. To enable a persistent multi-command shell:

* **Import Workflow:** Click Workflows > Import from File and select n8n_workflow_cve.json.
* **Save:** Click the Save button in the top right.
* **Activate:** Toggle the switch in the top-right corner to Active.
  * Note: This ensures the webhook stays open for multiple exploit attempts.

### üí£ 5. Launching the Exploit

Now that the lab is live and the workflow is active, run the exploit from your local machine:

# Clone the repo locally if you haven't already
```bash
git clone [https://github.com/rabakuku/LAB-CVES.git](https://github.com/rabakuku/LAB-CVES.git)
cd LAB-CVES/CVE-2026-21877

# Run the script
python3 exploit_n8n.py <LAB_PUBLIC_IP>
```

**Exploit Interaction:**

* When asked **"Use Production Mode?"**, type ``y``.
* This switches the script to use the ``/webhook/`` path instead of ``/webhook-test/``, allowing for a persistent session.

### üßπ 6. Cleanup

To avoid ongoing GCP costs, destroy the infrastructure when you are finished:
```bash
terraform destroy \
  -var="project_id=YOUR_PROJECT_ID_HERE" \
  -var="my_ip=$(curl -s ifconfig.me)/32"
```

-
### How this works:

1. **Static IP Reservation:** It reserves `lab-static-ip` so your IP stays consistent.
2. **Automated Firewall:** It creates the GCP firewall rules automatically so you don't have to do it in the console.
3. **Metadata Startup Script:**
* It installs Docker and Git upon the first boot.
* It uses a special GCP internal URL (`http://metadata.google.internal/...`) to ask the platform "What is my public IP?".
* It uses `sed` to find the `WEBHOOK_URL` in your `docker-compose.yml` and replace whatever is there with the correct IP.
* Finally, it fires up the containers.



### To use this:

1. Replace `your-project-id` with your actual GCP Project ID.
2. Run `terraform init` and `terraform apply`.
3. Wait about 2‚Äì3 minutes for the startup script to finish (installing Docker takes a moment).
4. Copy the IP from the Terraform output and run your exploit!

Would you like me to add a step to automatically create a "Mitigation" branch or any specific OS optimizations for the VM?
