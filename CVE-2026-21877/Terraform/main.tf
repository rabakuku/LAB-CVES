# Terraform configuration to deploy the CVE-2026-21877 Lab on GCP
# This version allows SSH from the GCP Console and your personal IP.

variable "project_id" {
  description = "The GCP Project ID"
  type        = string
  default     = "your-project-id" 
}

variable "my_ip" {
  description = "Your public IPv4 address (e.g., 1.2.3.4/32) to allow access"
  type        = string
  default     = "0.0.0.0/0"
}

variable "region" {
  default = "us-central1"
}

variable "zone" {
  default = "us-central1-a"
}

provider "google" {
  project = var.project_id
  region  = var.region
  zone    = var.zone
}

# 1. Reserve a Static External IP
resource "google_compute_address" "static_ip" {
  name = "lab-static-ip"
}

# 2. Create Firewall Rules
# Includes n8n (5678), Flask (5000), and SSH (22)
resource "google_compute_firewall" "lab_firewall" {
  name    = "allow-lab-traffic-restricted"
  network = "default"

  allow {
    protocol = "tcp"
    ports    = ["5678", "5000", "22"]
  }

  # Source Ranges:
  # - var.my_ip: Your personal IP for tools/scripting
  # - 35.235.240.0/20: Required for GCP Console "SSH" button (IAP)
  source_ranges = [var.my_ip, "35.235.240.0/20"]
  target_tags   = ["lab-vm"]
}

# 3. Provision the VM Instance
resource "google_compute_instance" "lab_vm" {
  name         = "cve-lab-instance"
  machine_type = "e2-medium"
  tags         = ["lab-vm"]

  boot_disk {
    initialize_params {
      image = "ubuntu-os-cloud/ubuntu-2204-lts"
      size  = 20
    }
  }

  network_interface {
    network = "default"
    access_config {
      nat_ip = google_compute_address.static_ip.address
    }
  }

  metadata_startup_script = <<-EOF
    #!/bin/bash
    set -e
    apt-get update
    apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release git
    mkdir -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    apt-get update
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
    cd /home/ubuntu
    git clone https://github.com/rabakuku/LAB-CVES.git || true
    cd LAB-CVES/CVE-2026-21877
    PUBLIC_IP=$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip)
    sed -i "s|WEBHOOK_URL=.*|WEBHOOK_URL=http://$PUBLIC_IP:5678|g" docker-compose.yml
    docker compose up -d
  EOF

}

output "lab_public_ip" {
  value = google_compute_address.static_ip.address
}

output "ssh_instruction" {
  value = "You can now use the 'SSH' button in GCP Console or: ssh -i ~/.ssh/id_rsa ubuntu@${google_compute_address.static_ip.address}"
}
